<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Toonify">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="Toonify로 만든 4컷 만화를 확인하세요!">

    <!-- Open Graph (카카오톡, 페이스북 등 미리보기) -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Toonify - 4컷 만화 완성!">
    <meta property="og:description" content="이 만화 어때요? Toonify에서 만들었어요!">
    <meta property="og:image" content="https://toonify.kr/static/images/og-image.png">
    <meta property="og:url" content="https://toonify.kr">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Toonify - 4컷 만화 완성!">
    <meta name="twitter:description" content="이 만화 어때요? Toonify에서 만들었어요!">
    <meta name="twitter:image" content="https://toonify.kr/static/images/og-image.png">

    <title>Toonify - 3줄 요약 대신 4컷 만화</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="icon" type="image/png" href="/static/images/favicon-32.png">
    <link rel="apple-touch-icon" href="/static/images/apple-touch-icon.png">
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.4/kakao.min.js" integrity="sha384-DKYJZ8NLiK8MN4/C5P2dtSmLQ4KwPaoqAfyA/DfmEc1VDxu4yyC7wy6K1Hs90nka" crossorigin="anonymous"></script>
    <style>
        @supports (padding: max(0px)) {
            body {
                padding-left: max(12px, env(safe-area-inset-left));
                padding-right: max(12px, env(safe-area-inset-right));
                padding-bottom: max(0px, env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>
    <div class="result-container">
        <div class="header">
            <div class="title-row">
                <a href="https://toonify.kr" class="logo-corner">
                    <img src="/static/images/logo.webp" alt="Toonify" class="logo">
                </a>
                <h1>Toonify</h1>
            </div>
            <p>3줄 요약 대신 4컷 만화</p>
            <div id="greeting" class="greeting hidden"></div>
        </div>

        <div class="comic-container" id="comic-container">
            <!-- JS로 렌더링 -->
            <p style="text-align: center; color: #999;">로딩 중...</p>
        </div>

        <div style="text-align: center;">
            <a href="/" class="back-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="19" y1="12" x2="5" y2="12"/>
                    <polyline points="12,19 5,12 12,5"/>
                </svg>
                새로운 만화 생성
            </a>
        </div>

        <footer class="footer">
            <div class="footer-links">
                <a href="https://kittly.shop" target="_blank">Kittly - 도구 모음</a>
                <a href="https://ploma.site" target="_blank">Ploma - 팀 뽀모도로</a>
                <a href="https://junhee1219.github.io/timer/" target="_blank">Timer - 개인용 타이머</a>
            </div>
            <p class="footer-contact">
                문의/제안: <a href="mailto:help-whatever@naver.com">help-whatever@naver.com</a>
            </p>
        </footer>
    </div>

    <!-- 이미지 뷰어 모달 -->
    <div class="viewer-overlay" id="viewer" onclick="onOverlayClick(event)">
        <button class="viewer-close" onclick="closeViewer()" aria-label="닫기">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>

        <button class="viewer-nav viewer-prev" onclick="navigate(-1)" aria-label="이전">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15,18 9,12 15,6"/>
            </svg>
        </button>

        <div class="viewer-content">
            <img class="viewer-img" id="viewer-img" src="" alt="">
            <div class="viewer-caption" id="viewer-caption"></div>
        </div>

        <button class="viewer-nav viewer-next" onclick="navigate(1)" aria-label="다음">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9,6 15,12 9,18"/>
            </svg>
        </button>

        <div class="viewer-counter" id="viewer-counter"></div>
    </div>

    <script>
        // API 서버 URL (GitHub Pages 배포 시 ngrok URL로 변경)
        const API_BASE_URL = '';  // 로컬: '', 배포: 'https://xxxx.ngrok-free.app'

        // ngrok 무료 버전 경고 페이지 우회용 헤더
        const ngrokHeaders = { 'ngrok-skip-browser-warning': 'true' };
        async function apiFetch(url, options = {}) {
            const headers = { ...ngrokHeaders, ...options.headers };
            return fetch(url, { ...options, headers });
        }

        let comicsData = [];
        let allSlides = [];
        let currentSlide = 0;
        let viewerOpen = false;

        const viewer = document.getElementById('viewer');
        const viewerImg = document.getElementById('viewer-img');
        const viewerCaption = document.getElementById('viewer-caption');
        const viewerCounter = document.getElementById('viewer-counter');
        const comicContainer = document.getElementById('comic-container');
        const greeting = document.getElementById('greeting');

        // 방문자 닉네임 로드
        let visitorId = localStorage.getItem('visitor_id');
        (async () => {
            try {
                const url = visitorId ? `${API_BASE_URL}/visitor?id=${visitorId}` : `${API_BASE_URL}/visitor`;
                const res = await apiFetch(url, { method: 'POST' });
                const data = await res.json();
                if (data.nickname) {
                    greeting.textContent = `${data.nickname}님, 어때요?`;
                    greeting.classList.remove('hidden');
                }
            } catch (e) { /* 실패해도 무시 */ }
        })();

        // URL에서 task_id 추출 (/view/{task_id} 형식)
        function getTaskId() {
            const path = window.location.pathname;
            const match = path.match(/\/view\/([^\/]+)/);
            return match ? match[1] : null;
        }

        // 데이터 로드 및 렌더링
        async function loadResult() {
            const taskId = getTaskId();
            if (!taskId) {
                comicContainer.innerHTML = '<p style="text-align: center; color: #c00;">task_id가 없습니다.</p>';
                return;
            }

            try {
                const response = await apiFetch(`${API_BASE_URL}/result/${taskId}`);
                if (!response.ok) throw new Error('결과를 불러올 수 없습니다.');

                const data = await response.json();

                if (data.task.status !== 'completed') {
                    comicContainer.innerHTML = `<p style="text-align: center; color: #999;">상태: ${data.task.status}</p>`;
                    return;
                }

                comicsData = data.comics.map(comic => ({
                    part_number: comic.part_number,
                    panels: comic.panels,
                    image_paths: comic.image_paths,
                }));

                renderComics();
                buildSlides();

            } catch (error) {
                comicContainer.innerHTML = `<p style="text-align: center; color: #c00;">${error.message}</p>`;
            }
        }

        function renderComics() {
            comicContainer.innerHTML = comicsData.map((comic, ci) => `
                <div class="comic">
                    <div class="panels">
                        ${comic.image_paths.map((path, pi) => `
                            <div class="panel">
                                <img
                                    src="${path}"
                                    alt="Panel ${pi + 1}"
                                    onclick="openViewer(${ci}, ${pi})"
                                >
                                ${comic.panels[pi] && comic.panels[pi].dialogue
                                    ? `<p>${comic.panels[pi].dialogue}</p>`
                                    : ''}
                            </div>
                        `).join('')}
                    </div>
                    <div class="download-section">
                        <button class="download-btn kakao-share-btn" onclick="shareKakao(${ci})" style="background: #FEE500; color: #000;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 3C6.48 3 2 6.58 2 11c0 2.83 1.88 5.31 4.68 6.72l-.95 3.52c-.08.29.25.54.51.38l4.2-2.8c.5.05 1.02.08 1.56.08 5.52 0 10-3.58 10-8s-4.48-8-10-8z"/>
                            </svg>
                            카카오톡 공유
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function buildSlides() {
            allSlides = [];
            comicsData.forEach((comic, ci) => {
                comic.image_paths.forEach((path, pi) => {
                    const panel = comic.panels && comic.panels[pi];
                    allSlides.push({
                        src: path,
                        caption: panel && panel.dialogue ? panel.dialogue : '',
                        label: `Page ${pi + 1}`,
                        comicIndex: ci,
                        panelIndex: pi,
                    });
                });
            });
        }

        function openViewer(comicIdx, panelIdx) {
            currentSlide = allSlides.findIndex(
                s => s.comicIndex === comicIdx && s.panelIndex === panelIdx
            );
            if (currentSlide === -1) currentSlide = 0;
            viewerOpen = true;
            viewer.classList.add('active');
            document.body.style.overflow = 'hidden';
            updateViewer();
        }

        function closeViewer() {
            viewerOpen = false;
            viewer.classList.remove('active');
            document.body.style.overflow = '';
        }

        function navigate(dir) {
            currentSlide = (currentSlide + dir + allSlides.length) % allSlides.length;
            updateViewer();
        }

        function updateViewer() {
            const slide = allSlides[currentSlide];
            viewerImg.src = slide.src;
            viewerCaption.textContent = slide.caption || slide.label;
            viewerCounter.textContent = `${currentSlide + 1} / ${allSlides.length}`;
        }

        function onOverlayClick(e) {
            if (e.target === viewer) closeViewer();
        }

        // 키보드
        document.addEventListener('keydown', (e) => {
            if (!viewerOpen) return;
            if (e.key === 'ArrowLeft') navigate(-1);
            else if (e.key === 'ArrowRight') navigate(1);
            else if (e.key === 'Escape') closeViewer();
        });

        // 스와이프 (모바일)
        let touchStartX = 0;
        viewer.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
        });
        viewer.addEventListener('touchend', (e) => {
            const diff = e.changedTouches[0].screenX - touchStartX;
            if (Math.abs(diff) > 50) {
                navigate(diff > 0 ? -1 : 1);
            }
        });

        // 카카오 SDK 초기화
        Kakao.init('955207d0a5010d84ca62d1c8d706c2b6');

        // 카카오톡 공유
        function shareKakao(comicIndex) {
            const comic = comicsData[comicIndex];
            const firstImageUrl = comic.image_paths[0];
            const currentUrl = window.location.href;

            Kakao.Share.sendDefault({
                objectType: 'feed',
                content: {
                    title: 'Toonify',
                    description: '이거 만화로 만들어봤는데 어때요?',
                    imageUrl: firstImageUrl,
                    link: {
                        mobileWebUrl: currentUrl,
                        webUrl: currentUrl,
                    },
                },
                buttons: [
                    {
                        title: '만화 보기',
                        link: {
                            mobileWebUrl: currentUrl,
                            webUrl: currentUrl,
                        },
                    },
                ],
            });
        }

        // 페이지 로드 시 실행
        loadResult();
    </script>
</body>
</html>
