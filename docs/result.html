<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Toon-Minutes">
    <meta name="theme-color" content="#000000">
    <title>ê²°ê³¼ - Toon-Minutes</title>
    <link rel="stylesheet" href="static/css/style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ™</text></svg>">
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.4/kakao.min.js" integrity="sha384-DKYJZ8NLiK8MN4/C5P2dtSmLQ4KwPaoqAfyA/DfmEc1VDxu4yyC7wy6K1Hs90nka" crossorigin="anonymous"></script>
    <style>
        @supports (padding: max(0px)) {
            body {
                padding-left: max(12px, env(safe-area-inset-left));
                padding-right: max(12px, env(safe-area-inset-right));
                padding-bottom: max(0px, env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>
    <div class="result-container">
        <div class="result-header">
            <h1>ìƒì„±ëœ ë§Œí™”</h1>
            <p>íšŒì˜ë¡ì´ 4ì»· ë§Œí™”ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤</p>
        </div>

        <div class="comic-container" id="comic-container">
            <!-- JSë¡œ ë Œë”ë§ -->
            <p style="text-align: center; color: #999;">ë¡œë”© ì¤‘...</p>
        </div>

        <div style="text-align: center;">
            <a href="https://junhee1219.github.io/toon-minutes/" class="back-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="19" y1="12" x2="5" y2="12"/>
                    <polyline points="12,19 5,12 12,5"/>
                </svg>
                ìƒˆë¡œìš´ ë§Œí™” ìƒì„±
            </a>
        </div>

        <footer class="footer">
            <div class="footer-links">
                <a href="https://kittly.shop" target="_blank">Kittly - ë„êµ¬ ëª¨ìŒ</a>
                <a href="https://ploma.site" target="_blank">Ploma - íŒ€ ë½€ëª¨ë„ë¡œ</a>
                <a href="https://junhee1219.github.io/timer/" target="_blank">Timer - ê°œì¸ìš© íƒ€ì´ë¨¸</a>
            </div>
            <p class="footer-contact">
                ë¬¸ì˜/ì œì•ˆ: <a href="mailto:help-whatever@naver.com">help-whatever@naver.com</a>
            </p>
        </footer>
    </div>

    <!-- ì´ë¯¸ì§€ ë·°ì–´ ëª¨ë‹¬ -->
    <div class="viewer-overlay" id="viewer" onclick="onOverlayClick(event)">
        <button class="viewer-close" onclick="closeViewer()" aria-label="ë‹«ê¸°">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>

        <button class="viewer-nav viewer-prev" onclick="navigate(-1)" aria-label="ì´ì „">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15,18 9,12 15,6"/>
            </svg>
        </button>

        <div class="viewer-content">
            <img class="viewer-img" id="viewer-img" src="" alt="">
            <div class="viewer-caption" id="viewer-caption"></div>
        </div>

        <button class="viewer-nav viewer-next" onclick="navigate(1)" aria-label="ë‹¤ìŒ">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9,6 15,12 9,18"/>
            </svg>
        </button>

        <div class="viewer-counter" id="viewer-counter"></div>
    </div>

    <script>
        // API ì„œë²„ URL (GitHub Pages ë°°í¬ ì‹œ ngrok URLë¡œ ë³€ê²½)
        const API_BASE_URL = 'https://noticed-lamb-contractor-adequate.trycloudflare.com';  // ë¡œì»¬: '', ë°°í¬: 'https://xxxx.ngrok-free.app'

        // ngrok ë¬´ë£Œ ë²„ì „ ê²½ê³  í˜ì´ì§€ ìš°íšŒìš© í—¤ë”
        const ngrokHeaders = { 'ngrok-skip-browser-warning': 'true' };
        async function apiFetch(url, options = {}) {
            const headers = { ...ngrokHeaders, ...options.headers };
            return fetch(url, { ...options, headers });
        }

        let comicsData = [];
        let allSlides = [];
        let currentSlide = 0;
        let viewerOpen = false;

        const viewer = document.getElementById('viewer');
        const viewerImg = document.getElementById('viewer-img');
        const viewerCaption = document.getElementById('viewer-caption');
        const viewerCounter = document.getElementById('viewer-counter');
        const comicContainer = document.getElementById('comic-container');

        // URLì—ì„œ task_id ì¶”ì¶œ (result.html?task={task_id} í˜•ì‹)
        function getTaskId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('task');
        }

        // ë°ì´í„° ë¡œë“œ ë° ë Œë”ë§
        async function loadResult() {
            const taskId = getTaskId();
            if (!taskId) {
                comicContainer.innerHTML = '<p style="text-align: center; color: #c00;">task_idê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            try {
                const response = await apiFetch(`${API_BASE_URL}/result/${taskId}`);
                if (!response.ok) throw new Error('ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

                const data = await response.json();

                if (data.task.status !== 'completed') {
                    comicContainer.innerHTML = `<p style="text-align: center; color: #999;">ìƒíƒœ: ${data.task.status}</p>`;
                    return;
                }

                comicsData = data.comics.map(comic => ({
                    part_number: comic.part_number,
                    panels: comic.panels,
                    image_paths: comic.image_paths,
                }));

                renderComics();
                buildSlides();

            } catch (error) {
                comicContainer.innerHTML = `<p style="text-align: center; color: #c00;">${error.message}</p>`;
            }
        }

        function renderComics() {
            comicContainer.innerHTML = comicsData.map((comic, ci) => `
                <div class="comic">
                    <div class="panels">
                        ${comic.image_paths.map((path, pi) => `
                            <div class="panel">
                                <img
                                    src="${path}"
                                    alt="Panel ${pi + 1}"
                                    onclick="openViewer(${ci}, ${pi})"
                                >
                                ${comic.panels[pi] && comic.panels[pi].dialogue
                                    ? `<p>${comic.panels[pi].dialogue}</p>`
                                    : ''}
                            </div>
                        `).join('')}
                    </div>
                    <div class="download-section">
                        <button class="download-btn" onclick="downloadAll(${ci})">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7,10 12,15 17,10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            ì „ì²´ ë‹¤ìš´ë¡œë“œ
                        </button>
                        <button class="download-btn kakao-share-btn" onclick="shareKakao(${ci})" style="background: #FEE500; color: #000;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 3C6.48 3 2 6.58 2 11c0 2.83 1.88 5.31 4.68 6.72l-.95 3.52c-.08.29.25.54.51.38l4.2-2.8c.5.05 1.02.08 1.56.08 5.52 0 10-3.58 10-8s-4.48-8-10-8z"/>
                            </svg>
                            ì¹´ì¹´ì˜¤í†¡ ê³µìœ 
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function buildSlides() {
            allSlides = [];
            comicsData.forEach((comic, ci) => {
                comic.image_paths.forEach((path, pi) => {
                    const panel = comic.panels && comic.panels[pi];
                    allSlides.push({
                        src: path,
                        caption: panel && panel.dialogue ? panel.dialogue : '',
                        label: `Part ${comic.part_number} - ${pi + 1}ì»·`,
                        comicIndex: ci,
                        panelIndex: pi,
                    });
                });
            });
        }

        function openViewer(comicIdx, panelIdx) {
            currentSlide = allSlides.findIndex(
                s => s.comicIndex === comicIdx && s.panelIndex === panelIdx
            );
            if (currentSlide === -1) currentSlide = 0;
            viewerOpen = true;
            viewer.classList.add('active');
            document.body.style.overflow = 'hidden';
            updateViewer();
        }

        function closeViewer() {
            viewerOpen = false;
            viewer.classList.remove('active');
            document.body.style.overflow = '';
        }

        function navigate(dir) {
            currentSlide = (currentSlide + dir + allSlides.length) % allSlides.length;
            updateViewer();
        }

        function updateViewer() {
            const slide = allSlides[currentSlide];
            viewerImg.src = slide.src;
            viewerCaption.textContent = slide.caption || slide.label;
            viewerCounter.textContent = `${currentSlide + 1} / ${allSlides.length}`;
        }

        function onOverlayClick(e) {
            if (e.target === viewer) closeViewer();
        }

        // í‚¤ë³´ë“œ
        document.addEventListener('keydown', (e) => {
            if (!viewerOpen) return;
            if (e.key === 'ArrowLeft') navigate(-1);
            else if (e.key === 'ArrowRight') navigate(1);
            else if (e.key === 'Escape') closeViewer();
        });

        // ìŠ¤ì™€ì´í”„ (ëª¨ë°”ì¼)
        let touchStartX = 0;
        viewer.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
        });
        viewer.addEventListener('touchend', (e) => {
            const diff = e.changedTouches[0].screenX - touchStartX;
            if (Math.abs(diff) > 50) {
                navigate(diff > 0 ? -1 : 1);
            }
        });

        // ë‹¤ìš´ë¡œë“œ
        async function downloadImage(url, filename) {
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            } catch (error) {
                window.open(url, '_blank');
            }
        }

        async function downloadAll(comicIndex) {
            const comic = comicsData[comicIndex];
            for (let i = 0; i < comic.image_paths.length; i++) {
                await downloadImage(
                    comic.image_paths[i],
                    `toon-minutes-part${comic.part_number}-panel${i + 1}.png`
                );
                await new Promise(r => setTimeout(r, 500));
            }
        }

        // ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™”
        Kakao.init('955207d0a5010d84ca62d1c8d706c2b6');

        // ì¹´ì¹´ì˜¤í†¡ ê³µìœ 
        function shareKakao(comicIndex) {
            const comic = comicsData[comicIndex];
            const firstImageUrl = comic.image_paths[0];
            const currentUrl = window.location.href;

            Kakao.Share.sendDefault({
                objectType: 'feed',
                content: {
                    title: 'Toon-Minutes',
                    description: 'íšŒì˜ë¡ì„ 4ì»· ë§Œí™”ë¡œ ë³€í™˜í–ˆì–´ìš”!',
                    imageUrl: firstImageUrl,
                    link: {
                        mobileWebUrl: currentUrl,
                        webUrl: currentUrl,
                    },
                },
                buttons: [
                    {
                        title: 'ë§Œí™” ë³´ê¸°',
                        link: {
                            mobileWebUrl: currentUrl,
                            webUrl: currentUrl,
                        },
                    },
                ],
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        loadResult();
    </script>
</body>
</html>
